function flatten(t,e){if("string"==typeof t)return t;var n=[];for(e in t){var a=flatten(t[e],e);a&&n.push(a)}return n.join(" ")}function parseText(t){tags={};var e={},n=d3.select("#per-line").property("checked");t.split(n?/\n/g:wordSeparators).forEach(function(t){discard.test(t)||(n||(t=t.replace(punctuation,"")),stopWords.test(t.toLowerCase())||(t=t.substr(0,maxLength),e[t.toLowerCase()]=t,tags[t=t.toLowerCase()]=(tags[t]||0)+1))}),(tags=d3.entries(tags).sort(function(t,e){return e.value-t.value})).forEach(function(t){t.key=e[t.key]}),generate()}function generate(){layout.font(d3.select("#font").property("value")).spiral(d3.select("input[name=spiral]:checked").property("value")),fontSize=d3.scale[d3.select("input[name=scale]:checked").property("value")]().range([10,100]),tags.length&&fontSize.domain([+tags[tags.length-1].value||1,+tags[0].value]),complete=0,statusText.style("display",null),words=[],layout.stop().words(tags.slice(0,max=Math.min(tags.length,+d3.select("#max").property("value")))).start()}function progress(t){statusText.text(++complete+"/"+max)}function draw(t,e){statusText.style("display","none"),scale=e?Math.min(w/Math.abs(e[1].x-w/2),w/Math.abs(e[0].x-w/2),h/Math.abs(e[1].y-h/2),h/Math.abs(e[0].y-h/2))/2:1,words=t;var n=vis.selectAll("text").data(words,function(t){return t.text.toLowerCase()});n.transition().duration(1e3).attr("transform",function(t){return"translate("+[t.x,t.y]+")rotate("+t.rotate+")"}).style("font-size",function(t){return t.size+"px"}),n.enter().append("text").attr("text-anchor","middle").attr("transform",function(t){return"translate("+[t.x,t.y]+")rotate("+t.rotate+")"}).style("font-size","1px").transition().duration(1e3).style("font-size",function(t){return t.size+"px"}),n.style("font-family",function(t){return t.font}).style("fill",function(t){return fill(t.text.toLowerCase())}).style("cursor",function(t){return"pointer"}).text(function(t){return t.text}).on("click",function(t,e){window.location.href="/family/"+species+"/"+t.text});var a=background.append("g").attr("transform",vis.attr("transform")),r=a.node();n.exit().each(function(){r.appendChild(this)}),a.transition().duration(1e3).style("opacity",1e-6).remove(),vis.transition().delay(1e3).duration(750).attr("transform","translate("+[w>>1,h>>1]+")scale("+scale+")")}function downloadPNG(){d3.event.preventDefault();var t=document.createElement("canvas"),e=t.getContext("2d");t.width=w,t.height=h,e.translate(w>>1,h>>1),e.scale(scale,scale),words.forEach(function(t,n){e.save(),e.translate(t.x,t.y),e.rotate(t.rotate*Math.PI/180),e.textAlign="center",e.fillStyle=fill(t.text.toLowerCase()),e.font=t.size+"px "+t.font,e.fillText(t.text,0,0),e.restore()}),echoContentType.attr("value","image/png"),echoInput.attr("value",t.toDataURL("image/png")),echoForm.node().submit()}function downloadSVG(){d3.event.preventDefault(),echoContentType.attr("value","image/svg+xml;charset=utf-8"),echoInput.attr("value",svg.attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML),echoForm.node().submit()}!function(t){function e(t){return t.text}function n(){return"serif"}function a(t){return Math.sqrt(t.value)}function r(){return 30*(~~(6*Math.random())-3)}function o(){return 1}function s(t,e,n){if(!t.sprite){g.clearRect(0,0,(f<<5)/y,p/y);var a=0,r=0,o=0,s=e.length;for(n--;++n<s;){t=e[n],g.save(),g.font=~~((t.size+1)/y)+"px "+t.font;var l=g.measureText(t.text+"m").width*y,i=t.size<<1;if(t.rotate){var u=Math.sin(t.rotate*h),c=Math.cos(t.rotate*h),d=l*c,v=l*u,x=i*c,m=i*u;l=Math.max(Math.abs(d+m),Math.abs(d-m))+31>>5<<5,i=~~Math.max(Math.abs(v+x),Math.abs(v-x))}else l=l+31>>5<<5;if(i>o&&(o=i),a+l>=f<<5&&(a=0,r+=o,o=0),r+i>=p)break;g.translate((a+(l>>1))/y,(r+(i>>1))/y),t.rotate&&g.rotate(t.rotate*h),g.fillText(t.text,0,0),g.restore(),t.width=l,t.height=i,t.xoff=a,t.yoff=r,t.x1=l>>1,t.y1=i>>1,t.x0=-t.x1,t.y0=-t.y1,a+=l}for(var w=g.getImageData(0,0,(f<<5)/y,p/y).data,M=[];--n>=0;){for(var b=(l=(t=e[n]).width)>>5,k=(i=t.y1-t.y0,t.padding),z=0;i*b>z;z++)M[z]=0;if(null==(a=t.xoff))return;r=t.yoff;for(var T=0,A=-1,C=0;i>C;C++){for(z=0;l>z;z++){var S=b*C+(z>>5),I=w[(r+C)*(f<<5)+(a+z)<<2]?1<<31-z%32:0;k&&(C&&(M[S-b]|=I),l-1>C&&(M[S+b]|=I),I|=I<<1|I>>1),M[S]|=I,T|=I}T?A=C:(t.y0++,i--,C--,r++)}t.y1=t.y0+A,t.sprite=M.slice(0,(t.y1-t.y0)*b)}}}function l(t,e,n){n>>=5;for(var a,r=t.sprite,o=t.width>>5,s=t.x-(o<<4),l=127&s,i=32-l,u=t.y1-t.y0,c=(t.y+t.y0)*n+(s>>5),d=0;u>d;d++){a=0;for(var h=0;o>=h;h++)if((a<<i|(o>h?(a=r[d*o+h])>>>l:0))&e[c+h])return!0;c+=n}return!1}function i(t,e){var n=t[0],a=t[1];e.x+e.x0<n.x&&(n.x=e.x+e.x0),e.y+e.y0<n.y&&(n.y=e.y+e.y0),e.x+e.x1>a.x&&(a.x=e.x+e.x1),e.y+e.y1>a.y&&(a.y=e.y+e.y1)}function u(t,e){return t.x+t.x1>e[0].x&&t.x+t.x0<e[1].x&&t.y+t.y1>e[0].y&&t.y+t.y0<e[1].y}function c(t){var e=t[0]/t[1];return function(t){return[e*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}var d,h=Math.PI/180,f=64,p=2048,y=1;"undefined"!=typeof document?((d=document.createElement("canvas")).width=1,d.height=1,y=Math.sqrt(d.getContext("2d").getImageData(0,0,1,1).data.length>>2),d.width=(f<<5)/y,d.height=p/y):d=new(require("canvas"))(f<<5,p);var g=d.getContext("2d"),v={archimedean:c,rectangular:function(t){var e=4*t[0]/t[1],n=0,a=0;return function(t){var r=0>t?-1:1;switch(Math.sqrt(1+4*r*t)-r&3){case 0:n+=e;break;case 1:a+=4;break;case 2:n-=e;break;default:a-=4}return[n,a]}}};g.fillStyle="red",g.textAlign="center",t.cloud=function(){function t(t,e,n){for(var a,r,o,s=(d[0],d[1],e.x),i=e.y,c=Math.sqrt(d[0]*d[0]+d[1]*d[1]),h=x(d),f=Math.random()<.5?1:-1,p=-f;(a=h(p+=f))&&(r=~~a[0],o=~~a[1],!(Math.min(r,o)>c));)if(e.x=s+r,e.y=i+o,!(e.x+e.x0<0||e.y+e.y0<0||e.x+e.x1>d[0]||e.y+e.y1>d[1])&&(!n||!l(e,t,d[0]))&&(!n||u(e,n))){for(var y,g=e.sprite,v=e.width>>5,m=d[0]>>5,w=e.x-(v<<4),M=127&w,b=32-M,k=e.y1-e.y0,z=(e.y+e.y0)*m+(w>>5),T=0;k>T;T++){y=0;for(var A=0;v>=A;A++)t[z+A]|=y<<b|(v>A?(y=g[T*v+A])>>>M:0);z+=m}return delete e.sprite,!0}return!1}var d=[256,256],h=e,f=n,p=a,y=r,g=o,x=c,m=[],w=1/0,M=d3.dispatch("word","end"),b=null,k={start:function(){function e(){for(var e,o=+new Date;+new Date-o<w&&++l<r&&b;)(e=c[l]).x=d[0]*(Math.random()+.5)>>1,e.y=d[1]*(Math.random()+.5)>>1,s(e,c,l),t(n,e,a)&&(u.push(e),M.word(e),a?i(a,e):a=[{x:e.x+e.x0,y:e.y+e.y0},{x:e.x+e.x1,y:e.y+e.y1}],e.x-=d[0]>>1,e.y-=d[1]>>1);l>=r&&(k.stop(),M.end(u,a))}var n=function(t){for(var e=[],n=-1;++n<t;)e[n]=0;return e}((d[0]>>5)*d[1]),a=null,r=m.length,l=-1,u=[],c=m.map(function(t,e){return{text:h.call(this,t,e),font:f.call(this,t,e),rotate:y.call(this,t,e),size:~~p.call(this,t,e),padding:o.call(this,t,e)}}).sort(function(t,e){return e.size-t.size});return b&&clearInterval(b),b=setInterval(e,0),e(),k},stop:function(){return b&&(clearInterval(b),b=null),k},timeInterval:function(t){return arguments.length?(w=null==t?1/0:t,k):w},words:function(t){return arguments.length?(m=t,k):m},size:function(t){return arguments.length?(d=[+t[0],+t[1]],k):d},font:function(t){return arguments.length?(f=d3.functor(t),k):f},rotate:function(t){return arguments.length?(y=d3.functor(t),k):y},text:function(t){return arguments.length?(h=d3.functor(t),k):h},spiral:function(t){return arguments.length?(x=v[t+""]||t,k):x},fontSize:function(t){return arguments.length?(p=d3.functor(t),k):p},padding:function(t){return arguments.length?(g=d3.functor(t),k):g}};return d3.rebind(k,M,"on")}}("undefined"==typeof exports?d3.layout||(d3.layout={}):exports);var max,tags,fontSize,fetcher,unicodePunctuationRe="!-#%-*,-/:;?@\\[-\\]_{}¡§«¶·»¿;·՚-՟։֊־׀׃׆׳״؉؊،؍؛؞؟٪-٭۔܀-܍߷-߹࠰-࠾࡞।॥॰૰෴๏๚๛༄-༒༔༺-༽྅࿐-࿔࿙࿚၊-၏჻፠-፨᐀᙭᙮᚛᚜᛫-᛭᜵᜶។-៖៘-៚᠀-᠊᥄᥅᨞᨟᪠-᪦᪨-᪭᭚-᭠᯼-᯿᰻-᰿᱾᱿᳀-᳇᳓‐-‧‰-⁃⁅-⁑⁓-⁞⁽⁾₍₎〈〉❨-❵⟅⟆⟦-⟯⦃-⦘⧘-⧛⧼⧽⳹-⳼⳾⳿⵰⸀-⸮⸰-⸻、-〃〈-】〔-〟〰〽゠・꓾꓿꘍-꘏꙳꙾꛲-꛷꡴-꡷꣎꣏꣸-꣺꤮꤯꥟꧁-꧍꧞꧟꩜-꩟꫞꫟꫰꫱꯫﴾﴿︐-︙︰-﹒﹔-﹡﹣﹨﹪﹫！-＃％-＊，-／：；？＠［-］＿｛｝｟-･",fill=d3.scale.category20b(),w=960,h=600,words=[],scale=1,complete=0,keyword="",maxLength=30,statusText=d3.select("#status"),layout=d3.layout.cloud().timeInterval(10).size([w,h]).fontSize(function(t){return fontSize(+t.value)}).text(function(t){return t.key}).on("word",progress).on("end",draw),echoForm=d3.select("body").append("form").attr("action","https://www.jasondavies.com/echo").attr("target","_blank").attr("method","POST"),echoContentType=echoForm.append("input").attr("type","hidden").attr("name","content-type"),echoInput=echoForm.append("input").attr("type","hidden").attr("name","echo"),svg=d3.select("#vis").append("svg").attr("width",w).attr("height",h),background=svg.append("g"),vis=svg.append("g").attr("transform","translate("+[w>>1,h>>1]+")");d3.select("#download-svg").on("click",downloadSVG),d3.select("#download-png").on("click",downloadPNG);var form=d3.select("#form").on("submit",function(){parseText(d3.select("#text").property("value")),d3.event.preventDefault()});form.selectAll("input[type=number]").on("click.refresh",function(){this.value!==this.defaultValue&&(generate(),this.defaultValue=this.value)}),form.selectAll("input[type=radio], #font").on("change",generate);var stopWords=/^(i|me|my|myself|we|us|our|ours|ourselves|you|your|yours|yourself|yourselves|he|him|his|himself|she|her|hers|herself|it|its|itself|they|them|their|theirs|themselves|what|which|who|whom|whose|this|that|these|those|am|is|are|was|were|be|been|being|have|has|had|having|do|does|did|doing|will|would|should|can|could|ought|i'm|you're|he's|she's|it's|we're|they're|i've|you've|we've|they've|i'd|you'd|he'd|she'd|we'd|they'd|i'll|you'll|he'll|she'll|we'll|they'll|isn't|aren't|wasn't|weren't|hasn't|haven't|hadn't|doesn't|don't|didn't|won't|wouldn't|shan't|shouldn't|can't|cannot|couldn't|mustn't|let's|that's|who's|what's|here's|there's|when's|where's|why's|how's|a|an|the|and|but|if|or|because|as|until|while|of|at|by|for|with|about|against|between|into|through|during|before|after|above|below|to|from|up|upon|down|in|out|on|off|over|under|again|further|then|once|here|there|when|where|why|how|all|any|both|each|few|more|most|other|some|such|no|nor|not|only|own|same|so|than|too|very|say|says|said|shall)$/,punctuation=new RegExp("["+unicodePunctuationRe+"]","g"),wordSeparators=/[ \f\n\r\t\v\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000\u3031-\u3035\u309b\u309c\u30a0\u30fc\uff70]+/g,discard=/^(@|https?:|\/\/)/,htmlTags=/(<[^>]*?>|<script.*?<\/script>|<style.*?<\/style>|<head.*?><\/head>)/g,matchTwitter=/^https?:\/\/([^\.]*\.)?twitter\.com/;d3.select("#random-palette").on("click",function(){paletteJSON("http://www.colourlovers.com/api/palettes/random",{},function(t){fill.range(t[0].colors),vis.selectAll("text").style("fill",function(t){return fill(t.text.toLowerCase())})}),d3.event.preventDefault()}),function(){function t(){o=+d3.select("#angle-count").property("value"),a=Math.max(-90,Math.min(90,+d3.select("#angle-from").property("value"))),r=Math.max(-90,Math.min(90,+d3.select("#angle-to").property("value"))),function t(){l.domain([0,o-1]).range([a,r]);var u=n.selectAll("path.angle").data([{startAngle:a*s,endAngle:r*s}]);u.enter().insert("path","circle").attr("class","angle").style("fill","#fc0"),u.attr("d",i);var c=n.selectAll("line.angle").data(d3.range(o).map(l));c.enter().append("line").attr("class","angle"),c.exit().remove(),c.attr("transform",function(t){return"rotate("+(90+t)+")"}).attr("x2",function(t,n){return n&&n!==o-1?-e:-e-5});var d=n.selectAll("path.drag").data([a,r]);d.enter().append("path").attr("class","drag").attr("d","M-9.5,0L-3,3.5L-3,-3.5Z").call(d3.behavior.drag().on("drag",function(n,o){n=(o?r:a)+90;var l=[-e*Math.cos(n*s),-e*Math.sin(n*s)],i=[d3.event.x,d3.event.y],u=~~(Math.atan2(l[0]*i[1]-l[1]*i[0],l[0]*i[0]+l[1]*i[1])/s);n=Math.max(-90,Math.min(90,n+u-90)),u=r-a,o?(r=n,u>360?a+=u-360:0>u&&(a=r)):(a=n,u>360?r+=360-u:0>u&&(r=a)),t()}).on("dragend",generate)),d.attr("transform",function(t){return"rotate("+(t+90)+")translate(-"+e+")"}),layout.rotate(function(){return l(~~(Math.random()*o))}),d3.select("#angle-count").property("value",o),d3.select("#angle-from").property("value",a),d3.select("#angle-to").property("value",r)}()}var e=40.5,n=d3.select("#angles").append("svg").attr("width",2*(e+35)).attr("height",e+30).append("g").attr("transform","translate("+[e+35,e+20]+")");n.append("path").style("fill","none").attr("d",["M",-e,0,"A",e,e,0,0,1,e,0].join(" ")),n.append("line").attr("x1",-e-7).attr("x2",e+7),n.append("line").attr("y2",-e-7),n.selectAll("text").data([-90,0,90]).enter().append("text").attr("dy",function(t,e){return 1===e?null:".3em"}).attr("text-anchor",function(t,e){return["end","middle","start"][e]}).attr("transform",function(t){return"rotate("+(t+=90)+")translate("+-(e+10)+")rotate("+-t+")translate(2)"}).text(function(t){return t+"°"});var a,r,o,s=Math.PI/180,l=d3.scale.linear(),i=d3.svg.arc().innerRadius(0).outerRadius(e);d3.selectAll("#angle-count, #angle-from, #angle-to").on("change",t).on("mouseup",t),t(),parseText(d3.select("#text").property("value"))}();